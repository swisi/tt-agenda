name: Cleanup Packages and Releases

on:
  workflow_dispatch:  # Nur manuell

permissions:
  packages: write
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Docker packages (repo-specific)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keepVersions = 2;
            
            // Alle Docker-Pakete des Owners holen
            const allPackages = await github.paginate(
              github.rest.packages.getPackagesForUser, 
              { username: owner, package_type: 'docker', per_page: 100 }
            );
            
            // Nur Pakete dieses Repos filtern
            const repoPackages = allPackages.filter(pkg => 
              pkg.repository && pkg.repository.name === repo
            );
            
            core.info(`Found ${repoPackages.length} Docker packages in ${owner}/${repo}`);
            
            for (const pkg of repoPackages) {
              const versions = await github.paginate(
                github.rest.packages.getAllPackageVersionsForPackageOwnedByUser,
                { username: owner, package_type: 'docker', package_name: pkg.name }
              );
              
              const sorted = versions.slice().sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
              );
              const toDelete = sorted.slice(keepVersions);
              
              core.info(`${pkg.name}: ${versions.length} versions, keeping ${keepVersions}`);
              
              for (const version of toDelete) {
                core.info(`Deleting ${pkg.name}@${version.id}`);
                await github.rest.packages.deletePackageVersionForUser({
                  username: owner,
                  package_type: 'docker',
                  package_name: pkg.name,
                  package_version_id: version.id
                });
              }
            }

      - name: Cleanup releases
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keepReleases = 2;
            const releases = await github.paginate(github.rest.repos.listReleases, { owner, repo });
            const sorted = releases.slice().sort((a, b) => 
              new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at)
            );
            const toDelete = sorted.slice(keepReleases);
            
            core.info(`Found ${releases.length} releases, deleting ${toDelete.length}`);
            for (const release of toDelete) {
              await github.rest.repos.deleteRelease({ owner, repo, release_id: release.id });
            }
