name: Cleanup Packages and Releases

on:
  workflow_dispatch:  # Nur manuell ausfÃ¼hrbar

permissions:
  packages: write
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      # Docker-Pakete dieses Repositories: Nur 2 neueste Versionen behalten
      - name: Cleanup Docker packages
        uses: actions/delete-package-versions@v5
        with:
          package-type: 'docker'
          min-versions-to-keep: 2
          
      # Releases dieses Repositories: Nur 2 neueste behalten  
      - name: Cleanup releases
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keepReleases = 2;

            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner, repo, per_page: 100
            });
            
            core.info(`Found ${releases.length} releases in ${owner}/${repo}`);
            const sorted = releases.slice().sort((a, b) => 
              new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at)
            );
            const toDelete = sorted.slice(keepReleases);

            core.info(`Keeping ${keepReleases} releases, deleting ${toDelete.length}`);

            for (const release of toDelete) {
              core.info(`Deleting release ${release.name || release.tag_name} (${release.id})`);
              await github.rest.repos.deleteRelease({
                owner, repo, release_id: release.id
              });
            }
