name: Cleanup Container Packages

on:
  workflow_dispatch:
    inputs:
      keep_versions:
        description: 'Anzahl der zu bewahrenden Versionen'
        required: false
        default: '5'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete untagged container versions
        shell: bash
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP: ${{ github.event.inputs.keep_versions || '5' }}
        run: |
          # Alle Versionen abrufen
          VERSIONS=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/user/packages/container/${{ github.event.repository.name }}/versions" | \
            jq -r '.[] | select(.metadata.container.tags | length == 0) | .id')
          
          # ZÃ¤hle die zu lÃ¶schenden Versionen
          DELETE_COUNT=$(echo "$VERSIONS" | grep -c . || echo 0)
          
          if [ $DELETE_COUNT -gt 0 ]; then
            echo "LÃ¶sche $DELETE_COUNT ungetaggte Versionen..."
            echo "$VERSIONS" | while read VERSION_ID; do
              curl -s -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: token $TOKEN" \
                "https://api.github.com/user/packages/container/${{ github.event.repository.name }}/versions/$VERSION_ID"
              echo "âœ“ Version $VERSION_ID gelÃ¶scht"
            done
          else
            echo "Keine ungetaggten Versionen zum LÃ¶schen gefunden"
          fi
      
      - name: Cleanup Summary
        run: |
          echo "## Package Cleanup abgeschlossen! ðŸ§¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Ungetaggte Versionen wurden entfernt" >> $GITHUB_STEP_SUMMARY
          echo "â­ Die letzten Versionen mit Tags bleiben erhalten" >> $GITHUB_STEP_SUMMARY
