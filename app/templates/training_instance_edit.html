{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-6 flex items-center gap-3">
        <div class="h-11 w-11 rounded-full bg-indigo-600/15 text-indigo-600 dark:text-indigo-200 flex items-center justify-center">
            <i class="bi bi-calendar-week"></i>
        </div>
        <div>
            <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Angepasster Termin</p>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Training am {{ instance.date.strftime('%d.%m.%Y') }} bearbeiten</h1>
            <p class="text-sm text-slate-600 dark:text-slate-400">{{ training.name }}</p>
        </div>
    </div>

    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                <i class="bi bi-list-check text-indigo-600 dark:text-indigo-400"></i>
                Aktivitäten
            </h2>
            <a href="{{ url_for('admin.edit_training', id=training.id) }}" class="inline-flex items-center gap-2 px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition text-sm font-semibold">
                <i class="bi bi-arrow-left"></i> Zum Template
            </a>
        </div>

        <div id="activities-list" class="space-y-2">
            {% for activity in activities %}
            {% set activity_def = ACTIVITY_TYPE_DEFS.get(activity.activity_type, {}) %}
            {% set activity_label = activity_def.label if activity_def else activity.activity_type %}
            {% set activity_behavior = activity_def.behavior if activity_def else '' %}
            <div class="bg-slate-50 dark:bg-slate-700/30 rounded-lg border border-slate-200 dark:border-slate-600 p-4 hover:shadow-md hover:border-indigo-300 dark:hover:border-indigo-600 transition-all activity-type-{{ activity.activity_type }}">
                <div class="flex gap-3 items-start">
                    <div class="flex flex-col gap-1 justify-start pt-0.5">
                        {% if not loop.first %}
                        <form method="POST" action="{{ url_for('admin.move_instance_activity_up', id=activity.id) }}" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="p-1.5 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 rounded transition" title="Nach oben">
                                <i class="bi bi-chevron-up text-sm"></i>
                            </button>
                        </form>
                        {% else %}<div class="p-1.5"></div>{% endif %}
                        {% if not loop.last %}
                        <form method="POST" action="{{ url_for('admin.move_instance_activity_down', id=activity.id) }}" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="p-1.5 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 rounded transition" title="Nach unten">
                                <i class="bi bi-chevron-down text-sm"></i>
                            </button>
                        </form>
                        {% else %}<div class="p-1.5"></div>{% endif %}
                    </div>

                    <div class="flex-grow min-w-0">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="flex-grow">
                                {% if activity_behavior == 'team' and activity.topic %}
                                <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ activity.topic }}</h4>
                                {% elif activity_behavior == 'individual' and activity.topics_json %}
                                {% set topics = activity.topics_json|parse_groups %}
                                {% set topic_values = topics.values()|list %}
                                {% if topic_values and topic_values|length > 0 %}
                                    {% set first_topic = topic_values[0] %}
                                    {% set all_same = topic_values|select('equalto', first_topic)|list|length == topic_values|length %}
                                    {% if all_same %}
                                    <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ first_topic }}</h4>
                                    {% else %}
                                    <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ activity_label }}</h4>
                                    <p class="text-xs text-slate-600 dark:text-slate-400 mt-0.5">verschiedene Themen</p>
                                    {% endif %}
                                {% else %}
                                <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ activity_label }}</h4>
                                {% endif %}
                                {% elif activity_behavior == 'group' and activity.topics_json %}
                                {% set combinations = activity.topics_json|parse_groups %}
                                {% if combinations and combinations|length > 0 %}
                                <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ combinations[0].topic }}</h4>
                                {% if combinations|length > 1 %}
                                <p class="text-xs text-slate-600 dark:text-slate-400 mt-0.5">+ {{ combinations|length - 1 }} weitere Gruppe(n)</p>
                                {% endif %}
                                {% else %}
                                <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ activity_label }}</h4>
                                {% endif %}
                                {% else %}
                                <h4 class="font-bold text-slate-900 dark:text-white text-base mb-0">{{ activity_label }}</h4>
                                {% endif %}
                            </div>
                            <span class="inline-block px-2.5 py-1 rounded-full text-xs font-semibold text-slate-700 dark:text-slate-200 bg-indigo-100 dark:bg-indigo-900/40 border border-indigo-200 dark:border-indigo-700 whitespace-nowrap flex-shrink-0">{{ activity_label }}</span>
                        </div>

                        <div class="flex items-center gap-3 text-xs mb-2">
                            <div class="flex items-center gap-1.5 text-slate-700 dark:text-slate-300">
                                <i class="bi bi-clock-history text-indigo-600 dark:text-indigo-400"></i>
                                <strong>{{ activity.start_time.strftime('%H:%M') }}</strong>
                            </div>
                            <div class="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium">
                                <i class="bi bi-hourglass-split text-amber-600 dark:text-amber-400 text-xs"></i>
                                {{ activity.duration }} Min
                            </div>
                        </div>

                        {% if activity_behavior == 'individual' and activity.topics_json %}
                        {% set topics = activity.topics_json|parse_groups %}
                        {% set topic_values = topics.values()|list %}
                        {% if topic_values and topic_values|length > 0 %}
                            {% set first_topic = topic_values[0] %}
                            {% set all_same = topic_values|select('equalto', first_topic)|list|length == topic_values|length %}
                            {% if not all_same %}
                            <details class="group mt-1.5">
                                <summary class="text-xs text-indigo-600 dark:text-indigo-400 cursor-pointer hover:underline font-medium">
                                    <i class="bi bi-chevron-right group-open:rotate-90 inline-block transition-transform text-xs"></i> Einzelne Themen
                                </summary>
                                <ul class="mt-2 ml-3 space-y-1 text-xs text-slate-700 dark:text-slate-300">
                                    {% for group, topic in topics.items() %}
                                    <li><i class="bi bi-square-fill text-indigo-500 mr-1.5 text-xs"></i><strong class="text-slate-900 dark:text-white">{{ group }}:</strong> {{ topic }}</li>
                                    {% endfor %}
                                </ul>
                            </details>
                            {% endif %}
                        {% endif %}
                        {% elif activity_behavior == 'group' and activity.topics_json %}
                        {% set combinations = activity.topics_json|parse_groups %}
                        {% if combinations and combinations|length > 1 %}
                        <details class="group mt-1.5">
                            <summary class="text-xs text-indigo-600 dark:text-indigo-400 cursor-pointer hover:underline font-medium">
                                <i class="bi bi-chevron-right group-open:rotate-90 inline-block transition-transform text-xs"></i> Alle Gruppen ({{ combinations|length }})
                            </summary>
                            <ul class="mt-2 ml-3 space-y-1 text-xs text-slate-700 dark:text-slate-300">
                                {% for combo in combinations %}
                                <li><i class="bi bi-square-fill text-indigo-500 mr-1.5 text-xs"></i>{{ combo.groups|join(' & ') }}: <strong class="text-slate-900 dark:text-white">{{ combo.topic }}</strong></li>
                                {% endfor %}
                            </ul>
                        </details>
                        {% endif %}
                        {% endif %}
                    </div>

                    <div class="flex gap-1.5 items-center flex-shrink-0">
                        <a href="{{ url_for('admin.edit_instance_activity', id=activity.id) }}" class="p-1.5 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 rounded-lg transition border border-indigo-300 dark:border-indigo-600 hover:border-indigo-500 dark:hover:border-indigo-500" title="Bearbeiten">
                            <i class="bi bi-pencil-fill text-sm"></i>
                        </a>
                        <form method="POST" action="{{ url_for('admin.delete_instance_activity', id=activity.id) }}" class="inline" onsubmit="return confirm('Aktivität wirklich löschen?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="p-1.5 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 rounded-lg transition border border-red-300 dark:border-red-600 hover:border-red-500 dark:hover:border-red-500" title="Löschen">
                                <i class="bi bi-trash-fill text-sm"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if not activities %}
            <div class="text-center py-8 text-slate-600 dark:text-slate-400">
                <i class="bi bi-inbox text-4xl mb-2 block opacity-50"></i>
                <p>Keine Aktivitäten vorhanden.</p>
            </div>
            {% endif %}
        </div>

        <a href="{{ url_for('admin.add_instance_activity', instance_id=instance.id) }}" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-lg transition transform hover:scale-105 shadow mt-4">
            <i class="bi bi-plus-circle"></i> Aktivität hinzufügen
        </a>
    </div>
</div>
{% endblock %}
