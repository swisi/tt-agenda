{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Zeitplan: {{ training.name }}</h1>
    <div class="page-actions align-items-center">
        <a href="{{ url_for('admin.edit_training', id=training.id) }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>Zur체ck
        </a>
        <label for="groupFilter" class="form-label mb-0 me-2">Filter:</label>
        <select id="groupFilter" class="form-select" style="width: auto;">
            <option value="all">Alle Gruppen</option>
            {% for group in position_groups %}
            <option value="{{ group }}">{{ group }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="table-responsive soft-card p-2">
    <table class="table schedule-table" id="scheduleTable">
        <thead class="table-dark">
            <tr>
                <th class="time-head">From</th>
                <th class="time-head">To</th>
                <th class="time-head">min</th>
                <th class="group-header" data-group="OL">OL</th>
                <th class="group-header" data-group="DL">DL</th>
                <th class="group-header" data-group="LB">LB</th>
                <th class="group-header" data-group="RB">RB</th>
                <th class="group-header" data-group="DB">DB</th>
                <th class="group-header" data-group="WR">WR</th>
                <th class="group-header" data-group="TE">TE</th>
                <th class="group-header" data-group="QB">QB</th>
            </tr>
        </thead>
        <tbody>
            {% set activities = training.activities|sort(attribute='order_index') %}
            {% for activity in activities %}
            {% set start_datetime = activity.start_time %}
            {% set end_time_minutes = (activity.start_time.hour * 60 + activity.start_time.minute + activity.duration) %}
            {% set end_hour = (end_time_minutes // 60) %}
            {% set end_min = (end_time_minutes % 60) %}
            
            {% set activity_color = activity.color if activity.color else '#10b981' %}
            <tr class="{% if loop.index % 2 == 0 %}table-row-even{% else %}table-row-odd{% endif %}">
                <td class="time-cell">{{ activity.start_time.strftime('%H:%M') }}</td>
                <td class="time-cell">{{ '%02d:%02d'|format(end_hour, end_min) }}</td>
                <td class="time-cell">{{ activity.duration }}</td>
                
                {% set cells = activity|build_group_cells %}
                {% for cell in cells %}
                <td class="{{ cell.class }} group-cell" {% if cell.colspan and cell.colspan > 1 %}colspan="{{ cell.colspan }}"{% endif %} 
                    data-groups="{{ cell.groups|join(',') if cell.groups else '' }}"
                    style="{% if cell.color %}background-color: var(--color-{{ activity.activity_type }}) !important;{% if cell.text_color %}color: {{ cell.text_color }} !important;{% endif %}{% endif %}">{% if cell.content and cell.content.strip() %}{{ cell.content }}{% else %}&nbsp;{% endif %}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
.schedule-table {
    border-collapse: separate;
    border-spacing: 0;
}

.schedule-table td, .schedule-table th {
    vertical-align: middle;
    text-align: center;
    padding: 0.75rem;
}

/* Filter Styles */
.group-header.hidden,
.group-cell.hidden {
    display: none !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterSelect = document.getElementById('groupFilter');
    const table = document.getElementById('scheduleTable');
    
    filterSelect.addEventListener('change', function() {
        const selectedGroup = this.value;
        
        // Alle Header und Zellen zeigen/verstecken
        const headers = table.querySelectorAll('th.group-header');
        const cells = table.querySelectorAll('td.group-cell');
        
        if (selectedGroup === 'all') {
            // Alle Gruppen anzeigen
            headers.forEach(header => {
                header.style.display = '';
                header.classList.remove('hidden');
            });
            cells.forEach(cell => {
                cell.style.display = '';
                cell.classList.remove('hidden');
            });
        } else {
            // Nur die ausgew채hlte Gruppe anzeigen
            headers.forEach(header => {
                const group = header.getAttribute('data-group');
                if (group === selectedGroup) {
                    header.style.display = '';
                    header.classList.remove('hidden');
                } else {
                    header.style.display = 'none';
                    header.classList.add('hidden');
                }
            });
            
            cells.forEach(cell => {
                const groupsAttr = cell.getAttribute('data-groups');
                const groups = groupsAttr ? groupsAttr.split(',') : [];
                
                // Zeige Zelle wenn sie die ausgew채hlte Gruppe enth채lt
                if (groups.includes(selectedGroup)) {
                    cell.style.display = '';
                    cell.classList.remove('hidden');
                } else {
                    cell.style.display = 'none';
                    cell.classList.add('hidden');
                }
            });
        }
    });
});
</script>
{% endblock %}
