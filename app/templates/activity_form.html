{% extends "base.html" %}

{% block content %}
{% set is_instance = instance is defined and instance %}
{% set activity_def = ACTIVITY_TYPE_DEFS.get(activity.activity_type, {}) if activity else {} %}
{% set activity_behavior = activity_def.behavior if activity_def else '' %}

<div class="max-w-4xl mx-auto">
    <div class="mb-6 flex items-center gap-3">
        <div class="h-11 w-11 rounded-full bg-indigo-600/15 text-indigo-600 dark:text-indigo-200 flex items-center justify-center">
            <i class="bi bi-activity"></i>
        </div>
        <div>
            <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">{{ 'Training' if training else 'Instanz' }}</p>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ 'Aktivität bearbeiten' if activity else 'Neue Aktivität' }}</h1>
        </div>
    </div>

    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-md p-6">
        <form method="POST" id="activityForm" onsubmit="return prepareFormSubmit()" action="{% if is_instance %}{{ url_for('admin.edit_instance_activity', id=activity.id) if activity else url_for('admin.add_instance_activity', instance_id=instance.id) }}{% else %}{{ url_for('admin.edit_activity', id=activity.id) if activity else url_for('admin.add_activity', training_id=training.id) }}{% endif %}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if training %}<input type="hidden" name="training_id" value="{{ training.id }}">{% endif %}
            {% if is_instance %}<input type="hidden" name="training_instance_id" value="{{ instance.id }}">{% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Typ</label>
                    <select name="activity_type" id="activity_type" required onchange="updateFormSections()" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        {% for key in ACTIVITY_TYPE_ORDER %}
                        {% set definition = ACTIVITY_TYPE_DEFS.get(key) %}
                        <option value="{{ key }}" {% if activity and activity.activity_type == key %}selected{% endif %}>{{ definition.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Dauer (Min)</label>
                    <input type="number" name="duration" value="{{ activity.duration if activity else 60 }}" required class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
            </div>

            <!-- Thema (Team/Prepractice) -->
            <div class="mb-5" id="topic_section" style="display: {% if activity and activity.activity_type in TEAM_LIKE_TYPES %}block{% elif not activity %}block{% else %}none{% endif %};">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Thema</label>
                <input type="text" name="topic" value="{{ activity.topic if activity and activity.topic else '' }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="z.B. Redzone Install">
            </div>

            <!-- Individual Section -->
            <div class="mb-6" id="individual_section" style="display: {% if activity and activity_behavior == 'individual' %}block{% else %}none{% endif %};">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Themen pro Gruppe</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 text-sm text-slate-800 dark:text-slate-200">
                        <input type="radio" class="h-4 w-4 text-indigo-600" name="individual_mode" id="individual_same" value="same" {% if individual_mode_same %}checked{% endif %} onchange="updateIndividualMode()">
                        Gleiches Thema für alle Gruppen
                    </label>
                    <label class="flex items-center gap-2 text-sm text-slate-800 dark:text-slate-200">
                        <input type="radio" class="h-4 w-4 text-indigo-600" name="individual_mode" id="individual_different" value="different" {% if not individual_mode_same %}checked{% endif %} onchange="updateIndividualMode()">
                        Unterschiedliche Themen pro Gruppe
                    </label>
                </div>
                <div id="individual_same_topic" class="mt-3" style="display: {% if individual_mode_same %}block{% else %}none{% endif %};">
                    <input type="text" name="individual_common_topic" id="individual_common_topic" value="{{ individual_common_topic }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Thema für alle Gruppen">
                </div>
                <div id="individual_topics_list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3" style="display: {% if individual_mode_same %}none{% else %}block{% endif %};">
                    {% for group in position_groups %}
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-1">{{ group }}</label>
                        <input type="text" name="individual_topic_{{ group }}" value="{{ individual_topics.get(group, '') }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Thema für {{ group }}">
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Group Section -->
            <div class="mb-6" id="group_section" style="display: {% if activity and activity_behavior == 'group' %}block{% else %}none{% endif %};">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">Gruppen-Kombinationen</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Definiere Themen pro Gruppenkombination</p>
                    </div>
                    <button type="button" onclick="addGroupCombination()" class="inline-flex items-center gap-2 px-3 py-2 text-sm font-semibold text-indigo-600 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-700 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/30">
                        <i class="bi bi-plus"></i> Kombination hinzufügen
                    </button>
                </div>
                <div id="group_combinations_list" class="space-y-3">
                    {% if activity and activity.topics_json %}
                        {% set combinations = activity.topics_json|parse_groups %}
                        {% for combo in combinations %}
                        <div class="bg-slate-50 dark:bg-slate-700/30 border border-slate-200 dark:border-slate-600 rounded-lg p-4 combo-item">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Gruppen</label>
                                    <div class="flex flex-wrap gap-3">
                                        {% for group in position_groups %}
                                        <label class="inline-flex items-center gap-2 text-sm text-slate-800 dark:text-slate-200">
                                            <input class="h-4 w-4 text-indigo-600 combo-group" type="checkbox" name="combo_{{ loop.index0 }}_groups" value="{{ group }}" id="combo_{{ loop.index0 }}_{{ group }}" {% if group in combo.groups %}checked{% endif %}>
                                            {{ group }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="flex items-end gap-3">
                                    <div class="flex-1">
                                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Thema</label>
                                        <input type="text" name="combo_{{ loop.index0 }}_topic" value="{{ combo.topic }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Thema für diese Kombination">
                                    </div>
                                    <button type="button" class="h-10 w-10 flex items-center justify-center text-red-600 dark:text-red-400 border border-red-200 dark:border-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30" onclick="removeComboItem(this)">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <input type="hidden" name="combo_count" id="combo_count" value="{{ (activity.topics_json|parse_groups|length) if activity and activity.topics_json else 0 }}">
            </div>

            <div class="flex justify-between items-center mt-8">
                <a href="{% if is_instance %}{{ url_for('admin.edit_training_instance', id=instance.id) }}{% else %}{{ training_edit_url if training_edit_url is defined else url_for('admin.edit_training', id=training.id) }}{% endif %}" class="px-5 py-2 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 transition">Abbrechen</a>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-semibold rounded-lg transition transform hover:scale-105 shadow">
                    Speichern
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Initialisiere comboCounter mit der Anzahl vorhandener Kombinationen
let comboCounter = {{ (activity.topics_json|parse_groups|length) if activity and activity.topics_json else 0 }};
// Stelle sicher, dass comboCounter mindestens so groß ist wie die Anzahl der Items
document.addEventListener('DOMContentLoaded', function() {
    const initialCount = document.querySelectorAll('.combo-item').length;
    if (initialCount > comboCounter) {
        comboCounter = initialCount;
    }
    // Stelle sicher, dass combo_count hidden field korrekt gesetzt ist
    document.getElementById('combo_count').value = initialCount;
});

const teamLikeTypes = {{ TEAM_LIKE_TYPES|tojson|safe }};
const activityTypeBehaviors = {{ ACTIVITY_TYPE_BEHAVIORS|tojson|safe }};
const individualTypes = Object.keys(activityTypeBehaviors).filter(key => activityTypeBehaviors[key] === 'individual');
const groupTypes = Object.keys(activityTypeBehaviors).filter(key => activityTypeBehaviors[key] === 'group');

function updateFormSections() {
    const type = document.getElementById('activity_type').value;
    document.getElementById('topic_section').style.display = teamLikeTypes.includes(type) ? 'block' : 'none';
    document.getElementById('individual_section').style.display = individualTypes.includes(type) ? 'block' : 'none';
    document.getElementById('group_section').style.display = groupTypes.includes(type) ? 'block' : 'none';
}

function updateIndividualMode() {
    const mode = document.querySelector('input[name="individual_mode"]:checked').value;
    document.getElementById('individual_same_topic').style.display = (mode === 'same') ? 'block' : 'none';
    document.getElementById('individual_topics_list').style.display = (mode === 'same') ? 'none' : 'block';
}

function addGroupCombination() {
    const container = document.getElementById('group_combinations_list');
    // Verwende die aktuelle Anzahl als neuen Index, damit keine Lücken entstehen
    const currentCount = document.querySelectorAll('.combo-item').length;
    const id = currentCount;
    const positionGroups = {{ position_groups|tojson|safe }};
    
    let groupsHTML = '';
    positionGroups.forEach(group => {
        groupsHTML += `<label class="inline-flex items-center gap-2 text-sm text-slate-800 dark:text-slate-200"><input class="h-4 w-4 text-indigo-600 combo-group" type="checkbox" name="combo_${id}_groups" value="${group}" id="combo_${id}_${group}">${group}</label>`;
    });

    const html = `<div class="bg-slate-50 dark:bg-slate-700/30 border border-slate-200 dark:border-slate-600 rounded-lg p-4 combo-item"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Gruppen</label><div class="flex flex-wrap gap-3">${groupsHTML}</div></div><div class="flex items-end gap-3"><div class="flex-1"><label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Thema</label><input type="text" name="combo_${id}_topic" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent combo-topic" placeholder="Thema für diese Kombination"></div><button type="button" class="h-10 w-10 flex items-center justify-center text-red-600 dark:text-red-400 border border-red-200 dark:border-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30" onclick="removeComboItem(this)"><i class="bi bi-x-lg"></i></button></div></div></div>`;
    container.insertAdjacentHTML('beforeend', html);
    comboCounter = id + 1;
    document.getElementById('combo_count').value = document.querySelectorAll('.combo-item').length;
}

function removeComboItem(button) {
    button.closest('.combo-item').remove();
    // Indizes neu nummerieren, damit keine Lücken entstehen
    renumberComboItems();
    const newCount = document.querySelectorAll('.combo-item').length;
    comboCounter = newCount;
}

function renumberComboItems() {
    const items = document.querySelectorAll('.combo-item');
    items.forEach((item, index) => {
        // Aktualisiere alle Checkbox-Namen und IDs mit dem neuen Index
        const checkboxes = item.querySelectorAll('input[type="checkbox"].combo-group');
        checkboxes.forEach(checkbox => {
            const groupName = checkbox.value;
            const oldId = checkbox.id;
            
            // Aktualisiere Name und ID der Checkbox
            checkbox.name = `combo_${index}_groups`;
            checkbox.id = `combo_${index}_${groupName}`;
            
            // Finde das zugehörige Label (suche nach dem Label, das auf die alte ID zeigt)
            const label = checkbox.closest('.form-check').querySelector('label');
            if (label) {
                label.setAttribute('for', `combo_${index}_${groupName}`);
            }
        });
        
        // Aktualisiere Topic-Input
        const topicInput = item.querySelector('input.combo-topic');
        if (topicInput) {
            topicInput.name = `combo_${index}_topic`;
        }
    });
}

// Stelle sicher, dass combo_count vor dem Submit aktualisiert wird
function prepareFormSubmit() {
    // Stelle sicher, dass alle Indizes korrekt sind
    renumberComboItems();
    const count = document.querySelectorAll('.combo-item').length;
    document.getElementById('combo_count').value = count;
    return true; // Formular absenden
}

// Farbselektor-Funktionen entfernt - Farben werden automatisch zugewiesen
</script>
{% endblock %}
