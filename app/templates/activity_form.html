{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">{{ 'Aktivität bearbeiten' if activity else 'Neue Aktivität' }}</h4>
            </div>
            <div class="card-body">
                {% set is_instance = instance is defined and instance %}
                {% set activity_def = ACTIVITY_TYPE_DEFS.get(activity.activity_type, {}) if activity else {} %}
                {% set activity_behavior = activity_def.behavior if activity_def else '' %}
                <form method="POST" action="{% if is_instance %}{{ url_for('admin.edit_instance_activity', id=activity.id) if activity else url_for('admin.add_instance_activity', instance_id=instance.id) }}{% else %}{{ url_for('admin.edit_activity', id=activity.id) if activity else url_for('admin.add_activity', training_id=training.id) }}{% endif %}" id="activityForm" onsubmit="return prepareFormSubmit()">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if training %}
                    <input type="hidden" name="training_id" value="{{ training.id }}">
                    {% endif %}
                    {% if is_instance %}
                    <input type="hidden" name="training_instance_id" value="{{ instance.id }}">
                    {% endif %}
                        
                        <div class="mb-3">
                            <label class="form-label">Typ</label>
                            <select name="activity_type" class="form-select" id="activity_type" onchange="updateFormSections()" required>
                                {% for key in ACTIVITY_TYPE_ORDER %}
                                {% set definition = ACTIVITY_TYPE_DEFS.get(key) %}
                                <option value="{{ key }}" {% if activity and activity.activity_type == key %}selected{% endif %}>
                                    {{ definition.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Dauer (Min)</label>
                            <input type="number" name="duration" class="form-control" value="{{ activity.duration if activity else 60 }}" required>
                        </div>
                        
                        
                        <!-- Topic Section (Team/Prepractice) -->
                        <div class="mb-3" id="topic_section" style="display: {% if activity and activity.activity_type in TEAM_LIKE_TYPES %}block{% elif not activity %}block{% else %}none{% endif %};">
                            <label class="form-label">Thema</label>
                            <input type="text" name="topic" class="form-control" value="{{ activity.topic if activity and activity.topic else '' }}">
                        </div>
                        
                        <!-- Individual Section -->
                        <div class="mb-3" id="individual_section" style="display: {% if activity and activity_behavior == 'individual' %}block{% else %}none{% endif %};">
                            <label class="form-label">Themen pro Gruppe</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="individual_mode" id="individual_same" value="same" {% if individual_mode_same %}checked{% endif %} onchange="updateIndividualMode()">
                                <label class="form-check-label" for="individual_same">Gleiches Thema für alle Gruppen</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="individual_mode" id="individual_different" value="different" {% if not individual_mode_same %}checked{% endif %} onchange="updateIndividualMode()">
                                <label class="form-check-label" for="individual_different">Unterschiedliche Themen pro Gruppe</label>
                            </div>
                            <div id="individual_same_topic" class="mb-3" style="display: {% if individual_mode_same %}block{% else %}none{% endif %};">
                                <input type="text" name="individual_common_topic" id="individual_common_topic" class="form-control" value="{{ individual_common_topic }}" placeholder="Thema für alle Gruppen">
                            </div>
                            <div id="individual_topics_list" style="display: {% if individual_mode_same %}none{% else %}block{% endif %};">
                                {% for group in position_groups %}
                                <div class="mb-2">
                                    <label class="form-label">{{ group }}</label>
                                    <input type="text" name="individual_topic_{{ group }}" class="form-control" value="{{ individual_topics.get(group, '') }}" placeholder="Thema für {{ group }}">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Group Section -->
                        <div class="mb-3" id="group_section" style="display: {% if activity and activity_behavior == 'group' %}block{% else %}none{% endif %};">
                            <label class="form-label">Gruppen-Kombinationen</label>
                            <div id="group_combinations_list">
                                {% if activity and activity.topics_json %}
                                    {% set combinations = activity.topics_json|parse_groups %}
                                    {% for combo in combinations %}
                                    <div class="card mb-2 combo-item">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label">Gruppen</label>
                                                    <div>
                                                        {% for group in position_groups %}
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input combo-group" type="checkbox" name="combo_{{ loop.index0 }}_groups" value="{{ group }}" id="combo_{{ loop.index0 }}_{{ group }}" {% if group in combo.groups %}checked{% endif %}>
                                                            <label class="form-check-label" for="combo_{{ loop.index0 }}_{{ group }}">{{ group }}</label>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="col-md-5 mb-2">
                                                    <label class="form-label">Thema</label>
                                                    <input type="text" name="combo_{{ loop.index0 }}_topic" class="form-control combo-topic" value="{{ combo.topic }}" placeholder="Thema für diese Kombination">
                                                </div>
                                                <div class="col-md-1 mb-2 d-flex align-items-end">
                                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeComboItem(this)">×</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <input type="hidden" name="combo_count" id="combo_count" value="{{ (activity.topics_json|parse_groups|length) if activity and activity.topics_json else 0 }}">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="addGroupCombination()">
                                <i class="bi bi-plus"></i> Kombination hinzufügen
                            </button>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% if is_instance %}{{ url_for('admin.edit_training_instance', id=instance.id) }}{% else %}{{ training_edit_url if training_edit_url is defined else url_for('admin.edit_training', id=training.id) }}{% endif %}" class="btn btn-secondary">Abbrechen</a>
                            <button type="submit" class="btn btn-primary">Speichern</button>
                        </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Initialisiere comboCounter mit der Anzahl vorhandener Kombinationen
let comboCounter = {{ (activity.topics_json|parse_groups|length) if activity and activity.topics_json else 0 }};
// Stelle sicher, dass comboCounter mindestens so groß ist wie die Anzahl der Items
document.addEventListener('DOMContentLoaded', function() {
    const initialCount = document.querySelectorAll('.combo-item').length;
    if (initialCount > comboCounter) {
        comboCounter = initialCount;
    }
    // Stelle sicher, dass combo_count hidden field korrekt gesetzt ist
    document.getElementById('combo_count').value = initialCount;
});

const teamLikeTypes = {{ TEAM_LIKE_TYPES|tojson|safe }};
const activityTypeBehaviors = {{ ACTIVITY_TYPE_BEHAVIORS|tojson|safe }};
const individualTypes = Object.keys(activityTypeBehaviors).filter(key => activityTypeBehaviors[key] === 'individual');
const groupTypes = Object.keys(activityTypeBehaviors).filter(key => activityTypeBehaviors[key] === 'group');

function updateFormSections() {
    const type = document.getElementById('activity_type').value;
    document.getElementById('topic_section').style.display = teamLikeTypes.includes(type) ? 'block' : 'none';
    document.getElementById('individual_section').style.display = individualTypes.includes(type) ? 'block' : 'none';
    document.getElementById('group_section').style.display = groupTypes.includes(type) ? 'block' : 'none';
}

function updateIndividualMode() {
    const mode = document.querySelector('input[name="individual_mode"]:checked').value;
    document.getElementById('individual_same_topic').style.display = (mode === 'same') ? 'block' : 'none';
    document.getElementById('individual_topics_list').style.display = (mode === 'same') ? 'none' : 'block';
}

function addGroupCombination() {
    const container = document.getElementById('group_combinations_list');
    // Verwende die aktuelle Anzahl als neuen Index, damit keine Lücken entstehen
    const currentCount = document.querySelectorAll('.combo-item').length;
    const id = currentCount;
    const positionGroups = {{ position_groups|tojson|safe }};
    
    let groupsHTML = '';
    positionGroups.forEach(group => {
        groupsHTML += `<div class="form-check form-check-inline"><input class="form-check-input combo-group" type="checkbox" name="combo_${id}_groups" value="${group}" id="combo_${id}_${group}"><label class="form-check-label" for="combo_${id}_${group}">${group}</label></div>`;
    });
    
    const html = `<div class="card mb-2 combo-item"><div class="card-body"><div class="row"><div class="col-md-6 mb-2"><label class="form-label">Gruppen</label><div>${groupsHTML}</div></div><div class="col-md-5 mb-2"><label class="form-label">Thema</label><input type="text" name="combo_${id}_topic" class="form-control combo-topic" placeholder="Thema für diese Kombination"></div><div class="col-md-1 mb-2 d-flex align-items-end"><button type="button" class="btn btn-sm btn-danger" onclick="removeComboItem(this)">×</button></div></div></div></div>`;
    container.insertAdjacentHTML('beforeend', html);
    comboCounter = id + 1;
    document.getElementById('combo_count').value = document.querySelectorAll('.combo-item').length;
}

function removeComboItem(button) {
    button.closest('.combo-item').remove();
    // Indizes neu nummerieren, damit keine Lücken entstehen
    renumberComboItems();
    const newCount = document.querySelectorAll('.combo-item').length;
    comboCounter = newCount;
}

function renumberComboItems() {
    const items = document.querySelectorAll('.combo-item');
    items.forEach((item, index) => {
        // Aktualisiere alle Checkbox-Namen und IDs mit dem neuen Index
        const checkboxes = item.querySelectorAll('input[type="checkbox"].combo-group');
        checkboxes.forEach(checkbox => {
            const groupName = checkbox.value;
            const oldId = checkbox.id;
            
            // Aktualisiere Name und ID der Checkbox
            checkbox.name = `combo_${index}_groups`;
            checkbox.id = `combo_${index}_${groupName}`;
            
            // Finde das zugehörige Label (suche nach dem Label, das auf die alte ID zeigt)
            const label = checkbox.closest('.form-check').querySelector('label');
            if (label) {
                label.setAttribute('for', `combo_${index}_${groupName}`);
            }
        });
        
        // Aktualisiere Topic-Input
        const topicInput = item.querySelector('input.combo-topic');
        if (topicInput) {
            topicInput.name = `combo_${index}_topic`;
        }
    });
}

// Stelle sicher, dass combo_count vor dem Submit aktualisiert wird
function prepareFormSubmit() {
    // Stelle sicher, dass alle Indizes korrekt sind
    renumberComboItems();
    const count = document.querySelectorAll('.combo-item').length;
    document.getElementById('combo_count').value = count;
    return true; // Formular absenden
}

// Farbselektor-Funktionen entfernt - Farben werden automatisch zugewiesen
</script>
{% endblock %}
