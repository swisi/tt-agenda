{% extends "base.html" %}

{% block content %}
{% set is_instance = instance is defined and instance %}
{% set activity_def = ACTIVITY_TYPE_DEFS.get(activity.activity_type, {}) if activity else {} %}
{% set activity_behavior = activity_def.behavior if activity_def else '' %}

<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-4 sm:mb-6 flex items-center gap-2 sm:gap-3">
        <div class="flex items-center justify-center w-9 h-9 sm:w-11 sm:h-11 bg-indigo-100 dark:bg-indigo-900/50 rounded-xl flex-shrink-0">
            <i class="bi bi-activity text-indigo-600 dark:text-indigo-400 text-sm sm:text-base"></i>
        </div>
        <div class="min-w-0">
            <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">{{ 'Training' if training else 'Instanz' }}</p>
            <h1 class="text-lg sm:text-2xl font-bold text-slate-900 dark:text-white truncate">{{ 'Aktivität bearbeiten' if activity else 'Neue Aktivität' }}</h1>
        </div>
    </div>

    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-md p-4 sm:p-6">
        <form method="POST" id="activityForm" onsubmit="return prepareFormSubmit()" action="{% if is_instance %}{{ url_for('admin.edit_instance_activity', id=activity.id) if activity else url_for('admin.add_instance_activity', instance_id=instance.id) }}{% else %}{{ url_for('admin.edit_activity', id=activity.id) if activity else url_for('admin.add_activity', training_id=training.id) }}{% endif %}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if training %}<input type="hidden" name="training_id" value="{{ training.id }}">{% endif %}
            {% if is_instance %}<input type="hidden" name="training_instance_id" value="{{ instance.id }}">{% endif %}

            <!-- Typ und Dauer -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Typ</label>
                    <select name="activity_type" id="activity_type" required onchange="updateFormSections()" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                        {% for key in ACTIVITY_TYPE_ORDER %}
                        {% set definition = ACTIVITY_TYPE_DEFS.get(key) %}
                        <option value="{{ key }}" {% if activity and activity.activity_type == key %}selected{% endif %}>{{ definition.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Dauer (Min)</label>
                    <input type="number" name="duration" value="{{ activity.duration if activity else 60 }}" required class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                </div>
            </div>

            <!-- Thema (Team/Prepractice) -->
            <div class="mb-4 sm:mb-5" id="topic_section" style="display: {% if activity and activity.activity_type in TEAM_LIKE_TYPES %}block{% elif not activity %}block{% else %}none{% endif %};">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Thema</label>
                <input type="text" name="topic" value="{{ activity.topic if activity and activity.topic else '' }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="z.B. Redzone Install">
            </div>

            <!-- Individual Section -->
            <div class="mb-4 sm:mb-6" id="individual_section" style="display: {% if activity and activity_behavior == 'individual' %}block{% else %}none{% endif %};">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2 sm:mb-3">Themen pro Gruppe</label>
                <div class="space-y-2 mb-3">
                    <label class="flex items-center gap-2 text-sm text-slate-800 dark:text-slate-200 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition">
                        <input type="radio" class="h-4 w-4 text-indigo-600" name="individual_mode" id="individual_same" value="same" {% if individual_mode_same %}checked{% endif %} onchange="updateIndividualMode()">
                        Gleiches Thema für alle Gruppen
                    </label>
                    <label class="flex items-center gap-2 text-sm text-slate-800 dark:text-slate-200 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer transition">
                        <input type="radio" class="h-4 w-4 text-indigo-600" name="individual_mode" id="individual_different" value="different" {% if not individual_mode_same %}checked{% endif %} onchange="updateIndividualMode()">
                        Unterschiedliche Themen pro Gruppe
                    </label>
                </div>
                <div id="individual_same_topic" class="mt-3" style="display: {% if individual_mode_same %}block{% else %}none{% endif %};">
                    <input type="text" name="individual_common_topic" id="individual_common_topic" value="{{ individual_common_topic }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-4 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Thema für alle Gruppen">
                </div>
                <div id="individual_topics_list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3" style="display: {% if individual_mode_same %}none{% else %}grid{% endif %};">
                    {% for group in position_groups %}
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-1">{{ group }}</label>
                        <input type="text" name="individual_topic_{{ group }}" value="{{ individual_topics.get(group, '') }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-3 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Thema für {{ group }}">
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Group Section -->
            <div class="mb-6" id="group_section" style="display: {% if activity and activity_behavior == 'group' %}block{% else %}none{% endif %};">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
                    <div>
                        <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">Gruppen-Kombinationen</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">Definiere Themen pro Gruppenkombination</p>
                    </div>
                    <button type="button" onclick="addGroupCombination()" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2.5 sm:py-2 text-sm font-semibold text-indigo-600 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-700 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition">
                        <i class="bi bi-plus"></i> Kombination hinzufügen
                    </button>
                </div>
                <div id="group_combinations_list" class="space-y-3">
                    {% if activity and activity.topics_json %}
                        {% set combinations = activity.topics_json|parse_groups %}
                        {% for combo in combinations %}
                        <div class="bg-slate-50 dark:bg-slate-700/30 border border-slate-200 dark:border-slate-600 rounded-lg p-3 sm:p-4 combo-item">
                            <div class="space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Gruppen</label>
                                    <div class="flex flex-wrap gap-2 sm:gap-3">
                                        {% for group in position_groups %}
                                        <label class="inline-flex items-center gap-1.5 text-sm text-slate-800 dark:text-slate-200 p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-600 cursor-pointer transition">
                                            <input class="h-4 w-4 text-indigo-600 combo-group" type="checkbox" name="combo_{{ loop.index0 }}_groups" value="{{ group }}" id="combo_{{ loop.index0 }}_{{ group }}" {% if group in combo.groups %}checked{% endif %}>
                                            <span class="text-xs sm:text-sm">{{ group }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="flex items-end gap-2 sm:gap-3">
                                    <div class="flex-1">
                                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Thema</label>
                                        <input type="text" name="combo_{{ loop.index0 }}_topic" value="{{ combo.topic }}" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-3 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition combo-topic" placeholder="Thema">
                                    </div>
                                    <button type="button" class="h-10 w-10 flex-shrink-0 flex items-center justify-center text-red-600 dark:text-red-400 border border-red-200 dark:border-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition" onclick="removeComboItem(this)">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <input type="hidden" name="combo_count" id="combo_count" value="{{ (activity.topics_json|parse_groups|length) if activity and activity.topics_json else 0 }}">
            </div>

            <!-- Actions -->
            <div class="flex flex-col-reverse sm:flex-row justify-between items-stretch sm:items-center gap-3 pt-4 sm:pt-6 border-t border-slate-200 dark:border-slate-700">
                <a href="{% if is_instance %}{{ url_for('admin.edit_training_instance', id=instance.id) }}{% else %}{{ training_edit_url if training_edit_url is defined else url_for('admin.edit_training', id=training.id) }}{% endif %}" class="px-5 py-3 sm:py-2.5 text-center rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                    Abbrechen
                </a>
                <button type="submit" class="px-6 py-3 sm:py-2.5 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 dark:from-indigo-500 dark:to-indigo-600 text-white font-semibold rounded-lg transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                    <i class="bi bi-check-lg"></i> Speichern
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Initialisiere comboCounter mit der Anzahl vorhandener Kombinationen
let comboCounter = {{ (activity.topics_json|parse_groups|length) if activity and activity.topics_json else 0 }};
// Stelle sicher, dass comboCounter mindestens so groß ist wie die Anzahl der Items
document.addEventListener('DOMContentLoaded', function() {
    const initialCount = document.querySelectorAll('.combo-item').length;
    if (initialCount > comboCounter) {
        comboCounter = initialCount;
    }
    // Stelle sicher, dass combo_count hidden field korrekt gesetzt ist
    document.getElementById('combo_count').value = initialCount;
});

const teamLikeTypes = {{ TEAM_LIKE_TYPES|tojson|safe }};
const activityTypeBehaviors = {{ ACTIVITY_TYPE_BEHAVIORS|tojson|safe }};
const individualTypes = Object.keys(activityTypeBehaviors).filter(key => activityTypeBehaviors[key] === 'individual');
const groupTypes = Object.keys(activityTypeBehaviors).filter(key => activityTypeBehaviors[key] === 'group');

function updateFormSections() {
    const type = document.getElementById('activity_type').value;
    document.getElementById('topic_section').style.display = teamLikeTypes.includes(type) ? 'block' : 'none';
    document.getElementById('individual_section').style.display = individualTypes.includes(type) ? 'block' : 'none';
    document.getElementById('group_section').style.display = groupTypes.includes(type) ? 'block' : 'none';
}

function updateIndividualMode() {
    const mode = document.querySelector('input[name="individual_mode"]:checked').value;
    document.getElementById('individual_same_topic').style.display = (mode === 'same') ? 'block' : 'none';
    document.getElementById('individual_topics_list').style.display = (mode === 'same') ? 'none' : 'grid';
}

function addGroupCombination() {
    const container = document.getElementById('group_combinations_list');
    const currentCount = document.querySelectorAll('.combo-item').length;
    const id = currentCount;
    const positionGroups = {{ position_groups|tojson|safe }};
    
    let groupsHTML = '';
    positionGroups.forEach(group => {
        groupsHTML += `<label class="inline-flex items-center gap-1.5 text-sm text-slate-800 dark:text-slate-200 p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-600 cursor-pointer transition"><input class="h-4 w-4 text-indigo-600 combo-group" type="checkbox" name="combo_${id}_groups" value="${group}" id="combo_${id}_${group}"><span class="text-xs sm:text-sm">${group}</span></label>`;
    });

    const html = `<div class="bg-slate-50 dark:bg-slate-700/30 border border-slate-200 dark:border-slate-600 rounded-lg p-3 sm:p-4 combo-item"><div class="space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4"><div><label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Gruppen</label><div class="flex flex-wrap gap-2 sm:gap-3">${groupsHTML}</div></div><div class="flex items-end gap-2 sm:gap-3"><div class="flex-1"><label class="block text-xs font-semibold text-slate-600 dark:text-slate-400 mb-2">Thema</label><input type="text" name="combo_${id}_topic" class="w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white px-3 py-2.5 sm:py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition combo-topic" placeholder="Thema"></div><button type="button" class="h-10 w-10 flex-shrink-0 flex items-center justify-center text-red-600 dark:text-red-400 border border-red-200 dark:border-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30 transition" onclick="removeComboItem(this)"><i class="bi bi-x-lg"></i></button></div></div></div>`;
    container.insertAdjacentHTML('beforeend', html);
    comboCounter = id + 1;
    document.getElementById('combo_count').value = document.querySelectorAll('.combo-item').length;
}

function removeComboItem(button) {
    button.closest('.combo-item').remove();
    renumberComboItems();
    const newCount = document.querySelectorAll('.combo-item').length;
    comboCounter = newCount;
}

function renumberComboItems() {
    const items = document.querySelectorAll('.combo-item');
    items.forEach((item, index) => {
        const checkboxes = item.querySelectorAll('input[type="checkbox"].combo-group');
        checkboxes.forEach(checkbox => {
            const groupName = checkbox.value;
            checkbox.name = `combo_${index}_groups`;
            checkbox.id = `combo_${index}_${groupName}`;
        });
        
        const topicInput = item.querySelector('input.combo-topic');
        if (topicInput) {
            topicInput.name = `combo_${index}_topic`;
        }
    });
}

function prepareFormSubmit() {
    renumberComboItems();
    const count = document.querySelectorAll('.combo-item').length;
    document.getElementById('combo_count').value = count;
    return true;
}
</script>
{% endblock %}
