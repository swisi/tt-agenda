{% extends "base.html" %}

{% block extra_head %}
<style>
    @keyframes live-pulse {
        0%, 100% {
            border-color: rgb(239, 68, 68);
            background-color: rgba(254, 226, 226, 1);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7), inset 0 0 0 3px rgba(239, 68, 68, 0.5);
        }
        50% {
            border-color: rgb(220, 38, 38);
            background-color: rgba(254, 202, 202, 1);
            box-shadow: 0 0 30px 10px rgba(239, 68, 68, 0.8), inset 0 0 0 3px rgba(220, 38, 38, 0.8);
        }
    }
    
    @media (prefers-color-scheme: dark) {
        @keyframes live-pulse {
            0%, 100% {
                border-color: rgb(239, 68, 68);
                background-color: rgba(127, 29, 29, 0.6);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7), inset 0 0 0 3px rgba(239, 68, 68, 0.5);
            }
            50% {
                border-color: rgb(220, 38, 38);
                background-color: rgba(127, 29, 29, 0.9);
                box-shadow: 0 0 30px 10px rgba(239, 68, 68, 0.8), inset 0 0 0 3px rgba(220, 38, 38, 0.8);
            }
        }
    }
    
    .live-row {
        animation: live-pulse 2s ease-in-out infinite;
        outline: 3px solid transparent;
    }
    
    .live-row td {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}

<!-- Live Training -->
{% if current_training %}
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden mb-6" id="live-training-widget">
    <!-- Header -->
    <div class="{% if training_status == 'running' %}bg-gradient-to-r from-red-600 to-red-500 dark:from-red-700 dark:to-red-600{% else %}bg-gradient-to-r from-indigo-600 to-blue-600 dark:from-indigo-700 dark:to-blue-700{% endif %} text-white px-3 py-1.5">
        <!-- Mobile Layout -->
        <div class="lg:hidden flex items-center justify-between gap-3">
            <!-- Left: Title, Date & Filter (stacked) -->
            <div class="flex-grow flex flex-col gap-1.5">
                <!-- Top: Training Name -->
                <div class="flex items-center gap-1.5 min-w-0">
                    {% if training_status == 'running' %}
                        <i class="bi bi-broadcast-pin text-xs flex-shrink-0"></i>
                    {% else %}
                        <i class="bi bi-clock text-xs flex-shrink-0"></i>
                    {% endif %}
                    <div class="text-sm font-bold truncate">{{ current_training.name }}</div>
                </div>
                
                <!-- Middle: Date -->
                <div class="text-white/80 text-xs">{{ (current_date or now).strftime('%d.%m.%Y') }}</div>
                
                <!-- Bottom: Filter -->
                <select 
                    id="liveGroupFilter" 
                    class="px-2 py-1 rounded-md bg-white/20 text-white text-xs focus:outline-none focus:ring-1 focus:ring-white/50 transition"
                >
                    <option value="all" class="text-slate-900">Alle</option>
                    {% for group in position_groups %}
                    <option value="{{ group }}" class="text-slate-900">{{ group }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Right: Countdown (3 lines, vertically centered) -->
            <div class="flex-shrink-0 flex items-center">
                {% if training_status == 'running' and current_activity %}
                <div id="countdown-timer-compact-mobile" class="countdown-timer-compact px-3 py-2 bg-white/20 rounded-md">
                    <div id="countdown-value-compact-mobile" class="text-4xl font-bold font-mono leading-tight tracking-tight">--:--</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Desktop Layout -->
        <div class="hidden lg:flex items-center justify-between gap-4">
            <!-- Left: Back & Timer -->
            <div class="flex items-center gap-3">
                <a href="{{ url_for('main.index') }}" class="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg transition flex items-center gap-2 text-sm">
                    <i class="bi bi-arrow-left"></i>
                    <span>Zurück</span>
                </a>
                {% if training_status == 'running' and current_activity %}
                <div id="countdown-timer-compact" class="countdown-timer-compact flex items-center gap-2 px-3 py-1.5 bg-white/20 rounded-lg text-sm">
                    <i class="bi bi-hourglass-split"></i>
                    <span id="countdown-value-compact">--:--</span>
                </div>
                {% endif %}
            </div>

            <!-- Center: Training Name -->
            <div class="flex-grow text-center">
                <h2 class="text-base font-bold">
                    {% if training_status == 'running' %}
                        <i class="bi bi-broadcast-pin mr-2"></i>{{ current_training.name }}
                    {% else %}
                        <i class="bi bi-clock mr-2"></i>{{ current_training.name }}
                    {% endif %}
                </h2>
                <p class="text-white/90 text-xs">{{ (current_date or now).strftime('%d.%m.%Y') }}</p>
            </div>

            <!-- Right: Group Filter -->
            <select 
                id="liveGroupFilterDesktop" 
                class="px-3 py-1.5 rounded-lg bg-white/20 text-white text-sm focus:outline-none focus:ring-2 focus:ring-white/50 transition"
            >
                <option value="all" class="text-slate-900">Alle</option>
                {% for group in position_groups %}
                <option value="{{ group }}" class="text-slate-900">{{ group }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Content -->
    <div class="p-3">
        {% if training_status == 'upcoming' %}
        <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-700 rounded-lg flex items-center gap-3">
            <i class="bi bi-info-circle text-blue-600 dark:text-blue-400 text-lg"></i>
            <p class="text-blue-900 dark:text-blue-200">
                <strong>Training startet um {{ current_training.start_time.strftime('%H:%M') }} Uhr</strong>
            </p>
        </div>
        {% endif %}

        <!-- Schedule Table - Desktop -->
        <div class="hidden lg:block overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
            <table class="w-full schedule-table" id="liveScheduleTable">
                <thead class="bg-slate-100 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white">Von</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white">Bis</th>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white">Min</th>
                        {% for group in position_groups %}
                        <th class="px-3 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white group-header" data-group="{{ group }}">{{ group }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% set activities = (display_activities if display_activities is not none else current_training.activities)|sort(attribute='order_index') %}
                    {% for activity in activities %}
                    {% set start_datetime = activity.start_time %}
                    {% set end_time_minutes = (activity.start_time.hour * 60 + activity.start_time.minute + activity.duration) %}
                    {% set end_hour = (end_time_minutes // 60) %}
                    {% set end_min = (end_time_minutes % 60) %}
                    {% set activity_end_time = (now.replace(hour=activity.start_time.hour, minute=activity.start_time.minute, second=0, microsecond=0) + timedelta(minutes=activity.duration)).time() %}
                    {% set is_current = training_status == 'running' and current_activity and current_activity.id == activity.id %}
                    {% set is_next = training_status == 'running' and next_activity and next_activity.id == activity.id and not current_activity %}
                    {% set is_finished = activity.start_time < now.time() and activity_end_time <= now.time() and training_status == 'running' %}
                    
                    <tr class="{% if is_current %}bg-red-50 dark:bg-red-900/30 border-4 border-red-500 live-row{% elif is_next %}bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-500{% elif is_finished %}bg-green-50 dark:bg-green-900/30 opacity-60{% else %}hover:bg-slate-50 dark:hover:bg-slate-700/50{% endif %} transition">
                        <td class="px-3 py-2 text-xs font-medium text-slate-900 dark:text-white whitespace-nowrap">{{ activity.start_time.strftime('%H:%M') }}</td>
                        <td class="px-3 py-2 text-xs font-medium text-slate-900 dark:text-white whitespace-nowrap">{{ '%02d:%02d'|format(end_hour, end_min) }}</td>
                        <td class="px-2 py-2 text-xs font-medium text-slate-900 dark:text-white whitespace-nowrap">
                            {{ activity.duration }}
                        </td>
                        
                        {% set cells = activity|build_group_cells %}
                        {% for cell in cells %}
                        <td class="px-3 py-2 text-xs font-medium text-center group-cell border-r border-slate-300 dark:border-slate-600 {% if loop.last %}border-r-0{% endif %} {% if cell.text_color %}font-semibold{% endif %}" 
                            {% if cell.colspan and cell.colspan > 1 %}colspan="{{ cell.colspan }}"{% endif %} 
                            data-groups="{{ cell.groups|join(',') if cell.groups else '' }}"
                            style="{% if cell.color %}background-color: var(--color-{{ activity.activity_type }});{% if cell.text_color %}color: {{ cell.text_color }} !important;{% endif %}{% endif %}"
                        >
                            {% if cell.content and cell.content.strip() %}{{ cell.content }}{% else %}<span class="text-slate-400 dark:text-slate-500">-</span>{% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Schedule Table - Mobile -->
        <div class="lg:hidden overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
            <table class="w-full schedule-table" id="liveScheduleTableMobile">
                <thead class="bg-slate-100 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white">Von</th>
                        <th class="px-2 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white">Bis</th>
                        <th class="px-1 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white hidden">Min</th>
                        {% for group in position_groups %}
                        <th class="px-2 py-2 text-left text-xs font-semibold text-slate-900 dark:text-white group-header-mobile" data-group="{{ group }}">{{ group }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% set activities = (display_activities if display_activities is not none else current_training.activities)|sort(attribute='order_index') %}
                    {% for activity in activities %}
                    {% set start_datetime = activity.start_time %}
                    {% set end_time_minutes = (activity.start_time.hour * 60 + activity.start_time.minute + activity.duration) %}
                    {% set end_hour = (end_time_minutes // 60) %}
                    {% set end_min = (end_time_minutes % 60) %}
                    {% set activity_end_time = (now.replace(hour=activity.start_time.hour, minute=activity.start_time.minute, second=0, microsecond=0) + timedelta(minutes=activity.duration)).time() %}
                    {% set is_current = training_status == 'running' and current_activity and current_activity.id == activity.id %}
                    {% set is_next = training_status == 'running' and next_activity and next_activity.id == activity.id and not current_activity %}
                    {% set is_finished = activity.start_time < now.time() and activity_end_time <= now.time() and training_status == 'running' %}
                    
                    <tr class="{% if is_current %}bg-red-50 dark:bg-red-900/30 border-4 border-red-500 live-row{% elif is_next %}bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-500{% elif is_finished %}bg-green-50 dark:bg-green-900/30 opacity-60{% else %}hover:bg-slate-50 dark:hover:bg-slate-700/50{% endif %} transition">
                        <td class="px-2 py-2 text-xs font-medium text-slate-900 dark:text-white whitespace-nowrap text-left">{{ activity.start_time.strftime('%H:%M') }}</td>
                        <td class="px-2 py-2 text-xs font-medium text-slate-900 dark:text-white whitespace-nowrap text-left">{{ '%02d:%02d'|format(end_hour, end_min) }}</td>
                        <td class="px-1 py-2 text-xs font-medium text-slate-900 dark:text-white whitespace-nowrap text-left hidden">{{ activity.duration }}</td>
                        
                        {% set cells = activity|build_group_cells %}
                        {% for cell in cells %}
                        <td class="px-2 py-2 text-xs font-medium text-left group-cell-mobile border-r border-slate-300 dark:border-slate-600 {% if loop.last %}border-r-0{% endif %} {% if cell.text_color %}font-semibold{% endif %}" 
                            {% if cell.colspan and cell.colspan > 1 %}colspan="{{ cell.colspan }}"{% endif %} 
                            data-groups="{{ cell.groups|join(',') if cell.groups else '' }}"
                            style="{% if cell.color %}background-color: var(--color-{{ activity.activity_type }});{% if cell.text_color %}color: {{ cell.text_color }} !important;{% endif %}{% endif %}"
                        >
                            {% if cell.content and cell.content.strip() %}{{ cell.content }}{% else %}<span class="text-slate-400 dark:text-slate-500">-</span>{% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 justify-center mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
            <a href="{{ url_for('main.index') }}" class="px-4 py-2.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 font-medium rounded-lg transition flex items-center justify-center gap-2">
                <i class="bi bi-house"></i>Zur Übersicht
            </a>
            {% if session.get('user_role') == 'admin' %}
            <form method="POST" action="{{ url_for('admin.create_training_instance', id=current_training.id) }}" class="contents">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="date" value="{{ (current_date or now.date()).strftime('%Y-%m-%d') }}">
                <button type="submit" class="px-4 py-2.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 hover:bg-yellow-200 dark:hover:bg-yellow-900/50 font-medium rounded-lg transition flex items-center justify-center gap-2">
                    <i class="bi bi-gear"></i>Individualisieren
                </button>
            </form>
            <form method="POST" action="{{ url_for('admin.cancel_training_instance', id=current_training.id) }}" class="contents">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="date" value="{{ (current_date or now.date()).strftime('%Y-%m-%d') }}">
                <button type="submit" class="px-4 py-2.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 font-medium rounded-lg transition flex items-center justify-center gap-2">
                    <i class="bi bi-x-circle"></i>Absagen
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Wake Lock - Verhindert Bildschirm-Sperre auf Mobile
    let wakeLock = null;
    
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake Lock aktiviert - Bildschirm bleibt an');
                
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock wurde freigegeben');
                });
            }
        } catch (err) {
            console.log('Wake Lock nicht unterstützt oder fehlgeschlagen:', err);
        }
    }
    
    // Wake Lock bei Sichtbarkeit erneut anfordern
    document.addEventListener('visibilitychange', async () => {
        if (document.visibilityState === 'visible' && wakeLock === null) {
            await requestWakeLock();
        }
    });
    
    // Wake Lock beim Laden aktivieren
    requestWakeLock();
    
    // Alarm Sound (Beep) bei 2:00 Minuten
    let alarmPlayed = false;
    
    function playAlarmSound() {
        // Erstelle einen Beep-Sound mit Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Beep-Frequenz und Lautstärke
        oscillator.frequency.value = 800; // Hz
        gainNode.gain.value = 0.3; // Lautstärke
        
        oscillator.type = 'sine';
        oscillator.start();
        
        // 3 kurze Beeps
        setTimeout(() => oscillator.stop(), 200);
        setTimeout(() => {
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();
            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.frequency.value = 800;
            gain2.gain.value = 0.3;
            osc2.type = 'sine';
            osc2.start();
            setTimeout(() => osc2.stop(), 200);
        }, 300);
        setTimeout(() => {
            const osc3 = audioContext.createOscillator();
            const gain3 = audioContext.createGain();
            osc3.connect(gain3);
            gain3.connect(audioContext.destination);
            osc3.frequency.value = 800;
            gain3.gain.value = 0.3;
            osc3.type = 'sine';
            osc3.start();
            setTimeout(() => osc3.stop(), 200);
        }, 600);
        
        console.log('⏰ Alarm: 2 Minuten verbleibend!');
    }

    // Countdown Timer
    {% if training_status == 'running' and current_activity %}
    (function() {
        const activityStartTime = new Date();
        const startParts = "{{ current_activity.start_time.strftime('%H:%M') }}".split(':');
        activityStartTime.setHours(parseInt(startParts[0]), parseInt(startParts[1]), 0, 0);
        
        const currentActivityEndTime = new Date(activityStartTime.getTime() + ({{ current_activity.duration }} * 60 * 1000));
        const serverTime = new Date("{{ now.strftime('%Y-%m-%d %H:%M:%S') }}");
        const clientTime = new Date();
        const timeDiff = serverTime - clientTime;
        
        function updateCountdown() {
            const now = new Date(new Date().getTime() + timeDiff);
            const diff = currentActivityEndTime - now;
            const timerDesktop = document.getElementById('countdown-timer-compact');
            const timerMobile = document.getElementById('countdown-timer-compact-mobile');
            
            if (diff <= 0) {
                if (document.getElementById('countdown-value-compact')) {
                    document.getElementById('countdown-value-compact').textContent = '00:00';
                }
                if (document.getElementById('countdown-value-compact-mobile')) {
                    document.getElementById('countdown-value-compact-mobile').textContent = '00:00';
                }
                if (timerDesktop) timerDesktop.classList.add('text-red-300');
                if (timerMobile) timerMobile.classList.add('text-red-300');
                setTimeout(function() {
                    location.reload();
                }, 2000);
                return;
            }
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            const display = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            
            // Alarm bei exakt 2:00 Minuten
            if (display === '02:00' && !alarmPlayed) {
                playAlarmSound();
                alarmPlayed = true;
            }
            
            if (document.getElementById('countdown-value-compact')) {
                document.getElementById('countdown-value-compact').textContent = display;
            }
            if (document.getElementById('countdown-value-compact-mobile')) {
                document.getElementById('countdown-value-compact-mobile').textContent = display;
            }
            
            if (diff < 120000) {
                if (timerDesktop) timerDesktop.classList.add('animate-pulse');
                if (timerMobile) timerMobile.classList.add('animate-pulse');
            }
            if (diff < 30000) {
                if (timerDesktop) timerDesktop.classList.add('bg-red-500/30');
                if (timerMobile) timerMobile.classList.add('bg-red-500/30');
            }
        }
        
        updateCountdown();
        setInterval(updateCountdown, 1000);
    })();
    {% endif %}

    // Group Filter - Sync both desktop and mobile
    document.addEventListener('DOMContentLoaded', function() {
        const filterMobile = document.getElementById('liveGroupFilter');
        const filterDesktop = document.getElementById('liveGroupFilterDesktop');
        const tableDesktop = document.getElementById('liveScheduleTable');
        const tableMobile = document.getElementById('liveScheduleTableMobile');
        
        function applyFilter(selectedGroup) {
            // Filter Desktop Table
            if (tableDesktop) {
                const headers = tableDesktop.querySelectorAll('th.group-header');
                const cells = tableDesktop.querySelectorAll('td.group-cell');
                
                if (selectedGroup === 'all') {
                    headers.forEach(header => header.style.display = '');
                    cells.forEach(cell => cell.style.display = '');
                } else {
                    headers.forEach(header => {
                        const group = header.getAttribute('data-group');
                        header.style.display = (group === selectedGroup) ? '' : 'none';
                    });
                    cells.forEach(cell => {
                        const groupsAttr = cell.getAttribute('data-groups');
                        const groups = groupsAttr ? groupsAttr.split(',') : [];
                        cell.style.display = groups.includes(selectedGroup) ? '' : 'none';
                    });
                }
            }
            
            // Filter Mobile Table
            if (tableMobile) {
                const headers = tableMobile.querySelectorAll('th.group-header-mobile');
                const cells = tableMobile.querySelectorAll('td.group-cell-mobile');
                
                if (selectedGroup === 'all') {
                    headers.forEach(header => header.style.display = '');
                    cells.forEach(cell => cell.style.display = '');
                } else {
                    headers.forEach(header => {
                        const group = header.getAttribute('data-group');
                        header.style.display = (group === selectedGroup) ? '' : 'none';
                    });
                    cells.forEach(cell => {
                        const groupsAttr = cell.getAttribute('data-groups');
                        const groups = groupsAttr ? groupsAttr.split(',') : [];
                        cell.style.display = groups.includes(selectedGroup) ? '' : 'none';
                    });
                }
            }
        }
        
        // Mobile filter change
        if (filterMobile) {
            filterMobile.addEventListener('change', function() {
                const selectedGroup = this.value;
                applyFilter(selectedGroup);
                if (filterDesktop) filterDesktop.value = selectedGroup;
            });
        }
        
        // Desktop filter change
        if (filterDesktop) {
            filterDesktop.addEventListener('change', function() {
                const selectedGroup = this.value;
                applyFilter(selectedGroup);
                if (filterMobile) filterMobile.value = selectedGroup;
            });
        }
    });
    
    // Auto-Refresh alle 5 Minuten
    setTimeout(function() {
        location.reload();
    }, 300000);
</script>

{% else %}
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 py-12 px-6 text-center">
    <div class="flex items-center justify-center w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full mx-auto mb-4">
        <i class="bi bi-calendar-x text-3xl text-slate-400 dark:text-slate-500"></i>
    </div>
    <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-2">Kein aktuelles Training</h3>
    <p class="text-slate-600 dark:text-slate-400 mb-6">Aktuell läuft kein Training und es ist auch keines für heute geplant</p>
    <a href="{{ url_for('main.index') }}" class="inline-flex items-center gap-2 px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-medium rounded-lg transition">
        <i class="bi bi-arrow-left"></i>Zurück zur Übersicht
    </a>
</div>
{% endif %}
{% endblock %}
