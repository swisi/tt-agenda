{% extends "base.html" %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="page-title">
        <i class="bi bi-gear-fill me-2"></i>Verwaltung
    </h1>
    <div class="page-actions">
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>Zurück zur Übersicht
        </a>
    </div>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-pills mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="templates-tab" data-bs-toggle="pill" data-bs-target="#templates" type="button" role="tab">
            <i class="bi bi-list-check me-2"></i>Templates
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="einmalig-tab" data-bs-toggle="pill" data-bs-target="#einmalig" type="button" role="tab">
            <i class="bi bi-calendar-plus me-2"></i>Einmalig
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="angepasst-tab" data-bs-toggle="pill" data-bs-target="#angepasst" type="button" role="tab">
            <i class="bi bi-calendar2-week me-2"></i>Angepasst
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="aktivitaetstypen-tab" data-bs-toggle="pill" data-bs-target="#aktivitaetstypen" type="button" role="tab">
            <i class="bi bi-tags me-2"></i>Aktivitätstypen
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="backup-tab" data-bs-toggle="pill" data-bs-target="#backup" type="button" role="tab">
            <i class="bi bi-database-down me-2"></i>Backup
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="adminTabsContent">
    <!-- Templates Tab -->
    <div class="tab-pane fade show active" id="templates" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="bi bi-list-check me-2"></i>Trainings Templates</h3>
            <a href="{{ url_for('admin.new_training') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Neues Training
            </a>
        </div>
        
        <form class="row g-2 align-items-center mb-3" 
              hx-get="{{ url_for('admin.trainings_partial') }}" 
              hx-target="#trainings-list" 
              hx-swap="innerHTML" 
              hx-push-url="false">
            <div class="col-sm-8 col-md-6 col-lg-4">
                <input type="search" name="q" value="{{ request.args.get('q', '') }}" class="form-control" placeholder="Suche nach Name…">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-search me-1"></i>Filtern
                </button>
            </div>
        </form>

        {% if trainings|length == 0 %}
        <div class="text-center py-5">
            <i class="bi bi-inbox empty-state-icon"></i>
            <h4 class="mt-3 text-muted">Keine Trainings vorhanden</h4>
            <p class="text-muted">Erstellen Sie Ihr erstes Training</p>
            <a href="{{ url_for('admin.new_training') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Neues Training
            </a>
        </div>
        {% else %}
        <div id="trainings-list">
            {% include 'includes/trainings_table.html' %}
        </div>
        {% endif %}
    </div>

    <!-- Einmalig Tab -->
    <div class="tab-pane fade" id="einmalig" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="bi bi-calendar-plus me-2"></i>Einmalige Trainings</h3>
            <a href="{{ url_for('admin.new_hidden_training') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Neues einmaliges Training
            </a>
        </div>

        {% if hidden_trainings|length == 0 %}
        <div class="text-center py-5">
            <i class="bi bi-inbox empty-state-icon"></i>
            <h4 class="mt-3 text-muted">Keine einmaligen Trainings vorhanden</h4>
            <p class="text-muted">Erstellen Sie ein einmaliges Training</p>
            <a href="{{ url_for('admin.new_hidden_training') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Neues einmaliges Training
            </a>
        </div>
        {% else %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Datum</th>
                        <th>Startzeit</th>
                        <th>Aktivitäten</th>
                        <th class="text-end">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for training in hidden_trainings %}
                    <tr>
                        <td><strong>{{ training.name }}</strong></td>
                        <td>{{ training.start_date.strftime('%d.%m.%Y') }}</td>
                        <td><i class="bi bi-clock me-1"></i>{{ training.start_time.strftime('%H:%M') }}</td>
                        <td><span class="badge bg-info">{{ training.activities|length }} Aktivitäten</span></td>
                        <td>
                            <div class="d-flex justify-content-end gap-1">
                                <a href="{{ url_for('admin.edit_hidden_training', id=training.id) }}" class="btn btn-sm btn-outline-primary" title="Bearbeiten">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <form method="POST" action="{{ url_for('admin.delete_hidden_training', id=training.id) }}" class="inline-form"
                                      onsubmit="return confirm('Training &quot;{{ training.name }}&quot; wirklich löschen?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Löschen">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Angepasst Tab -->
    <div class="tab-pane fade" id="angepasst" role="tabpanel">
        <div class="mb-3">
            <h3><i class="bi bi-calendar2-week me-2"></i>Angepasste Termine</h3>
            <p class="text-muted">Individuelle Anpassungen von Template-Trainings</p>
        </div>

        {% if instances|length == 0 %}
        <div class="text-center py-5">
            <i class="bi bi-inbox empty-state-icon"></i>
            <h4 class="mt-3 text-muted">Keine angepassten Termine vorhanden</h4>
            <p class="text-muted">Angepasste Termine werden über die Templates erstellt</p>
        </div>
        {% else %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Training</th>
                        <th>Datum</th>
                        <th>Status</th>
                        <th>Startzeit</th>
                        <th>Aktivitäten</th>
                        <th class="text-end">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for instance in instances %}
                    <tr>
                        <td><strong>{{ instance.training.name }}</strong></td>
                        <td>{{ instance.date.strftime('%d.%m.%Y') }}</td>
                        <td>
                            {% if instance.status == 'cancelled' %}
                            <span class="badge bg-danger">Abgesagt</span>
                            {% else %}
                            <span class="badge bg-success">Aktiv</span>
                            {% endif %}
                        </td>
                        <td><i class="bi bi-clock me-1"></i>{{ instance.start_time.strftime('%H:%M') }}</td>
                        <td><span class="badge bg-info">{{ instance.activities|length }} Aktivitäten</span></td>
                        <td>
                            <div class="d-flex justify-content-end gap-1">
                                <a href="{{ url_for('admin.edit_training_instance', id=instance.id) }}" class="btn btn-sm btn-outline-primary" title="Bearbeiten">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <form method="POST" action="{{ url_for('admin.delete_training_instance', id=instance.id) }}" class="inline-form"
                                      onsubmit="return confirm('Angepassten Termin wirklich entfernen?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Löschen">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Aktivitätstypen Tab -->
    <div class="tab-pane fade" id="aktivitaetstypen" role="tabpanel">
        <div class="mb-3">
            <h3><i class="bi bi-tags me-2"></i>Aktivitätstypen</h3>
            <p class="text-muted">Verwalten Sie die verschiedenen Aktivitätstypen und deren Darstellung</p>
        </div>

        <form method="POST" action="{{ url_for('admin.admin_activity_types') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="table-responsive">
                <table class="table">
                    <thead class="table-dark">
                        <tr>
                            <th>Key</th>
                            <th>Label</th>
                            <th>Verhalten</th>
                            <th>Badge-Klasse</th>
                            <th>Light Color</th>
                            <th>Dark Color</th>
                            <th>Reihenfolge</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for at in activity_types %}
                        <tr>
                            <td><code>{{ at.key }}</code></td>
                            <td><input type="text" name="label_{{ at.key }}" value="{{ at.label }}" class="form-control form-control-sm"></td>
                            <td><input type="text" name="behavior_{{ at.key }}" value="{{ at.behavior }}" class="form-control form-control-sm"></td>
                            <td><input type="text" name="badge_class_{{ at.key }}" value="{{ at.badge_class }}" class="form-control form-control-sm"></td>
                            <td><input type="color" name="light_color_{{ at.key }}" value="{{ at.light_color }}" class="form-control form-control-sm"></td>
                            <td><input type="color" name="dark_color_{{ at.key }}" value="{{ at.dark_color }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="sort_order_{{ at.key }}" value="{{ at.sort_order }}" class="form-control form-control-sm" style="width: 80px;"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>Änderungen speichern
                </button>
            </div>
        </form>
    </div>

    <!-- Backup Tab -->
    <div class="tab-pane fade" id="backup" role="tabpanel">
        <div class="mb-3">
            <h3><i class="bi bi-database-down me-2"></i>Backup & Restore</h3>
            <p class="text-muted">Sichern und wiederherstellen Sie Ihre Datenbank</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-download me-2"></i>Backup erstellen</h5>
                    </div>
                    <div class="card-body">
                        <p>Laden Sie eine Sicherungskopie Ihrer Datenbank herunter.</p>
                        {% if db_exists %}
                        <a href="{{ url_for('admin.admin_backup_download') }}" class="btn btn-primary">
                            <i class="bi bi-download me-1"></i>Backup herunterladen
                        </a>
                        {% else %}
                        <div class="alert alert-warning">Datenbank nicht gefunden.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Backup wiederherstellen</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('admin.admin_backup_restore') }}" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <label class="form-label">Backup-Datei auswählen</label>
                                <input type="file" name="backup_file" class="form-control" accept=".db" required>
                            </div>
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Achtung:</strong> Dies überschreibt alle aktuellen Daten!
                            </div>
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Wirklich alle Daten mit diesem Backup ersetzen?');">
                                <i class="bi bi-upload me-1"></i>Backup hochladen
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Tooltips initialisieren
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}
{% endblock %}
