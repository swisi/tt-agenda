name: 09.) Cleanup Container Packages

on:
  workflow_dispatch:
    inputs:
      keep_versions:
        description: 'Anzahl der zu bewahrenden Versionen'
        required: false
        default: '5'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete old and untagged container versions
        shell: bash
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP: ${{ github.event.inputs.keep_versions || '5' }}
          PKG_NAME: ${{ github.event.repository.name }}
        run: |
          echo "ðŸ§¹ Cleanup starten - Behalte die letzten $KEEP Versionen"
          
          # Alle Versionen abrufen (sortiert nach Creation Date, neueste zuerst)
          ALL_VERSIONS=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/user/packages/container/$PKG_NAME/versions?state=active" | \
            jq -r '.[] | "\(.created_at)|\(.id)|\(.metadata.container.tags | join(","))"' | \
            sort -rV)
          
          # Konvertiere in Array
          VERSIONS_ARRAY=()
          while IFS='|' read -r DATE ID TAGS; do
            VERSIONS_ARRAY+=("$DATE|$ID|$TAGS")
          done <<< "$ALL_VERSIONS"
          
          TOTAL=${#VERSIONS_ARRAY[@]}
          KEEP_INT=$KEEP
          
          echo "ðŸ“Š Gefundene Versionen: $TOTAL (behalte: $KEEP_INT)"
          
          DELETE_COUNT=0
          
          # LÃ¶sche alle Versionen auÃŸer den letzten KEEP Versionen
          for i in "${!VERSIONS_ARRAY[@]}"; do
            if [ $i -lt $KEEP_INT ]; then
              # Behalte diese Version
              IFS='|' read -r DATE ID TAGS <<< "${VERSIONS_ARRAY[$i]}"
              if [ -z "$TAGS" ]; then
                echo "âœ… Behalte Version $((i+1))/$TOTAL (ungetaggt) - $ID"
              else
                echo "âœ… Behalte Version $((i+1))/$TOTAL (Tags: $TAGS) - $ID"
              fi
            else
              # LÃ¶sche diese Version
              IFS='|' read -r DATE ID TAGS <<< "${VERSIONS_ARRAY[$i]}"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: token $TOKEN" \
                "https://api.github.com/user/packages/container/$PKG_NAME/versions/$ID")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              
              if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
                if [ -z "$TAGS" ]; then
                  echo "ðŸ—‘ï¸  GelÃ¶scht: Version $((i+1))/$TOTAL (ungetaggt) - $ID"
                else
                  echo "ðŸ—‘ï¸  GelÃ¶scht: Version $((i+1))/$TOTAL (Tags: $TAGS) - $ID"
                fi
                ((DELETE_COUNT++))
              else
                echo "âŒ Fehler beim LÃ¶schen von $ID (HTTP $HTTP_CODE)"
              fi
            fi
          done
          
          echo ""
          echo "ðŸ“ˆ Zusammenfassung:"
          echo "  - Gesamt Versionen: $TOTAL"
          echo "  - Bewahrte Versionen: $KEEP_INT"
          echo "  - GelÃ¶schte Versionen: $DELETE_COUNT"
      
      - name: Cleanup Summary
        run: |
          echo "## Package Cleanup abgeschlossen! ðŸ§¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Alte und ungetaggte Versionen wurden gelÃ¶scht" >> $GITHUB_STEP_SUMMARY
          echo "â­ Die letzten **${{ github.event.inputs.keep_versions || '5' }}** Versionen wurden behalten" >> $GITHUB_STEP_SUMMARY
          echo "â­ Die letzten Versionen mit Tags bleiben erhalten" >> $GITHUB_STEP_SUMMARY
